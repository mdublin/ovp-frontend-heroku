{% extends "base.html" %}

{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Media{% endblock %}


{% block page_content %}
    

{% block styles %}
    {{super()}}
    <link rel="stylesheet"
        href="{{url_for('static', filename='newstyle.css')}}">
    {% endblock %}


	<script src="{{ url_for('static', filename='clipboardJS/clipboard.min.js') }}"></script>

    <h1>Search Media</h1>
	<p>You are logged in as <b>{{ current_user.username }}</b>.</p>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<!-- AJAX form load --!>

<!-- new Boostrap form to be used with AJAX --!>	   

<form id="videoform" name="bootform" form>
	<div id="form_results"></div>
	<fieldset class="form-group">
    <label for="exampleTextarea">Enter search tag:</label>
	<textarea class="form-control" name="tag" id="tagform" rows="1"></textarea>
	<small class="text-muted">*Separate tags with a comma; no tag > 128 characters</small>
  </fieldset>
	<small class="text-muted"></small>
  </fieldset>
  <button type="submit" id="submit_btn" class="btn btn-primary">Submit</button>
</form>

	   <!-- this is the pagination just for the general media load on /media --!>
	   <nav>
		<ul class="pager">
		{% if page > 1 %}
		<li><a href="{{ url_for('main.media', page=(page - 1)) }}"><b>Previous</b></a></li>
        {% endif %}
		<li><a href="{{ url_for('main.media', page=(page + 1)) }}"><b>Next</b></a></li>
      </ul>
    </nav>


	<nav>
<ul class="pager">

	<li><button type="button" class="btn btn-primary-outline" input type="submit" id="prevPage" onclick="return prevPage();"/>Previous</button></li>
	<li><button type="button" class="btn btn-primary" input type="submit" id="nextPage" onclick="return nextPage();" />Next</button></li>
</ul>
</nav>





<div id="defaultMedia">
<!-- loop through video_package object for general load on /media --!>
{% for dict in video_package %}
<div class="list-group">
	<a href="http://127.0.0.1:8000/" class="list-group-item active" id="mediaItem--{{loop.index}}">
		<h4 class="list-group-item-heading">{{ dict["name"] }}</h4>
		<img src={{ dict["thumbnail"] }} height="90" width="160">
		<p class="list-group-item-text">{{ dict["description"] }}</p>
   		<p class="list-group-item-text">Some info here</p>
	</a>
</div>

 {% endfor %}
</div>



<!-- div for inserting tag query results --!>
<div id="footest"></div>







<script>


var current_tag;

var current_page = 1;

var btn_prev = document.getElementById("#prevPage");
var btn_next = document.getElementById("#nextPage");


//pagination config check for initial search query results load
	function pagConfig(){

		if (current_page == 1) {

        	$('#prevPage').hide();
			}
		
		else{
			$('#prevPage').show();

		}
	}
  

window.onload = function(){
		pagConfig();
};


if(current_tag < 1){

		$("#prevPage").hide();
	}


function prevPage()
{

	// page increment 
	current_page = current_page - 1;
	
    // add page numbers to FormData object, using .set() instead of .append()
	//https://developer.mozilla.org/en-US/docs/Web/API/FormData/append
	current_tag.set('page_number', current_page);

	// https://developer.mozilla.org/en-US/docs/Web/API/FormData/entries
	
	var oReq = new XMLHttpRequest();
  
  	oReq.open("POST", "/media", true);
  	oReq.onload = function(oEvent) {
		if (oReq.status == 200) {
			alert("200 Response!");

		var ovpResponse = JSON.parse(oReq.responseText);
		
		//alert(ovpResponse);
		var serverResponseBody = ovpResponse['response_dict'];

		var vidInsert;

		vidInsert = document.querySelector("#footest");

		$("#defaultMedia").hide();

		//clear the div for each new tag search request
		document.getElementById("footest").innerHTML = "";

        var vidPacket = JSON.stringify(serverResponseBody);

		var vidPacketMod = JSON.parse(vidPacket);
		var div = document.createElement('div');
			
		div.innerHTML += '<div id="defaultMediaTest">{% for dict in '+vidPacketMod+' %}<div class="list-group"><a href="http://127.0.0.1:8000/" class="list-group-item active" id="mediaItem--{{loop.index}}"><h4 class="list-group-item-heading">{{ dict }}</h4><img src={{ dict["thumbnail"] }} height="90" width="160"><p class="list-group-item-text">{{ dict["description"] }}</p><p class="list-group-item-text">Some info here</p></a></div>{% endfor %}</div>';


		vidInsert.appendChild(div);

		alert(div.innerHTML);

		/*
		for(i = 0; i < serverResponseBody.length; i++){
			var vidPacket = JSON.stringify(serverResponseBody[i]);

			// converting to JSON object so we can extract values of keys in each packet
			var vidPacketMod = JSON.parse(vidPacket);
			console.log(vidPacketMod);
			console.log(vidPacketMod["description"]);

			var idxID = i;
			var desc = vidPacketMod["description"];
			var name = vidPacketMod["name"];
			var url = vidPacketMod['url'];
		 	var thumbnail = vidPacketMod['thumbnail'];

			var div = document.createElement('div');

			div.innerHTML += '<div id="jumbo-resize"><class="modal fade"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">Modal title</h4></div><div class="modal-body"><p>One fine body&hellip;</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button><button type="button" class="btn btn-primary">Save changes</button></div></div></div></div></div>';

			//div.innerHTML += '<div class="list-group" id='+idxID+' ><a href='+url+' class="list-group-item active"><h4 class="list-group-item-heading">'+name+'</h4><img src='+thumbnail+' height="90" width="160"><p class="list-group-item-text">'+desc+'</p><p class="list-group-item-text">Some info here</p></a></div><button type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal--'+idxID+'">Get Asset Data</button><div class="modal fade" id="myModal--'+idxID+'" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="myModalLabel--'+idxID+'">'+name+'</h4></div><div class="modal-body"><p><b>DESCRIPTION: </b>'+desc+'</p><p><b>TAGS: </b>'+ tags+'</p><data-clipboard-text='+desc+'><button class="btn" data-clipboard-target="#myModalLabel--'+idxID+'">Copy Source File Url</button></div><script src="/static/clipboardJS/clipboard.min.js"><\/script><script>var btn = document.getElementById("btn"); var clipboard = new Clipboard("btn"); clipboard.on("success", function(e) { console.log(e); }); clipboard.on("error", function(e) { console.log(e);});<\/script></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div></div></div></div></div>';


			vidInsert.appendChild(div);

			//call pagConfig() to set up pagination buttons
			pagConfig();

		}; */


		}
		else {
			alert(oReq.status);

		}
	}

	oReq.send(current_tag);

}




function nextPage()
{

	// page increment 
	current_page = current_page + 1;
	
    // add page numbers to FormData object, using .set() instead of .append()
	//https://developer.mozilla.org/en-US/docs/Web/API/FormData/append
	current_tag.set('page_number', current_page);

	// https://developer.mozilla.org/en-US/docs/Web/API/FormData/entries
	
	var oReq = new XMLHttpRequest();
  
  	oReq.open("POST", "/media", true);
  	oReq.onload = function(oEvent) {
		if (oReq.status == 200) {
			//alert("200 Response!");

		var ovpResponse = JSON.parse(oReq.responseText);
		
		//alert(ovpResponse);
		var serverResponseBody = ovpResponse['response_dict'];

		var vidInsert;

		vidInsert = document.querySelector("#footest");
		
		$("#defaultMedia").hide();

		//clear the div for each new tag search request
		document.getElementById("footest").innerHTML = "";

		
		for(i = 0; i < serverResponseBody.length; i++){
			var vidPacket = JSON.stringify(serverResponseBody[i]);

			// converting to JSON object so we can extract values of keys in each packet
			var vidPacketMod = JSON.parse(vidPacket);
			console.log(vidPacketMod);
			console.log(vidPacketMod["description"]);

			var idxID = i;
			var desc = vidPacketMod["description"];
			var name = vidPacketMod["name"];
			var url = vidPacketMod['url'];
			var thumbnail = vidPacketMod['thumbnail'];
			var tags = vidPacketMod['tags'];

			var div = document.createElement('div');

			// using index of loop to create unique elements with each innerHTML insertion

			div.innerHTML += '<div class="list-group" id="'+idxID+'"><h4 class="list-group-item-heading">'+name+'</h4><img src='+thumbnail+' height="120" width="190"><p class="list-group-item-text">'+desc+'</p><p class="list-group-item-text">Some info here</p><button type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal-'+idxID+'">Get Asset Data</button><div class="modal fade" id="myModal-'+idxID+'" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Video Title</h4></div><div class="modal-body"><p><b>DESCRIPTION:</b> '+desc+'</p><p><b>TAGS:</b> '+tags+'</p><button class="btn btn-clipboard" data-clipboard-text='+url+'>Copy Source File Url</button></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div></div>';

			vidInsert.appendChild(div);

			console.log($('.btn').length);

			//call pagConfig() to set up pagination buttons
			pagConfig();

		};

			// creating Clipboard.js function one time, after innerHTML loads all the blobs into the DOM. 
			// this uses Clipboard.js "imperative API", see here under Advanced Usage: https://clipboardjs.com/

		new Clipboard('.btn-clipboard', {
			text: function(trigger) {
				//alert(trigger.getAttribute('data-clipboard-text'));
    			return trigger.getAttribute('data-clipboard-text');
			}
		});

		// older version/alternative way of instantiaing clipboard.js to catch buttons
		//var clipboard = new Clipboard(".btn"); 
		//clipboard.on("success", function(e) { console.log(e); }); 
		//clipboard.on("error", function(e) { console.log(e); });
		
		}
		
		else {
			alert(oReq.status);

		}
	}

	oReq.send(current_tag);

  //When you use preventDefault(), you prevent the form from undergoing a traditional POST where your page would be submitted and reloaded. 
  //ev.preventDefault();
 

}




var form;	
form = document.forms.namedItem("bootform");
form.addEventListener('submit', function(ev) {

  //var oOutput = document.querySelector("div");
  var oData = new FormData(form);

  var oReq = new XMLHttpRequest();
  

  oReq.open("POST", "/media", true);
  oReq.onload = function(oEvent) {
	  if (oReq.status == 200) {

		//alert("200 status");
		//ovpResponse = oReq.responseText;
		
		var ovpResponse = JSON.parse(oReq.responseText);
		
		//alert(ovpResponse);
		
		var serverResponseBody = ovpResponse['response_dict'];

		var vidInsert;

		vidInsert = document.querySelector("#footest");
		
		$("#defaultMedia").hide();

		//clear the div for each new tag search request
		document.getElementById("footest").innerHTML = "";

		for(i = 0; i < serverResponseBody.length; i++){
			var vidPacket = JSON.stringify(serverResponseBody[i]);

			// converting to JSON object so we can extract values of keys in each packet
			var vidPacketMod = JSON.parse(vidPacket);
			console.log(vidPacketMod);
			console.log(vidPacketMod["description"]);

			var idxID = i;
			var desc = vidPacketMod["description"];
			var name = vidPacketMod["name"];
			var url = vidPacketMod['url'];
			var thumbnail = vidPacketMod['thumbnail'];

			var div = document.createElement('div');

			div.innerHTML += '<div class="list-group" id='+idxID+' ><a href='+url+' class="list-group-item active"><h4 class="list-group-item-heading">'+name+'</h4><img src='+thumbnail+' height="90" width="160"><p class="list-group-item-text">'+desc+'</p><p class="list-group-item-text">Some info here</p></a></div>';

			vidInsert.appendChild(div);

		};

		//$('#footest').html(ovpResponse.response_dict);
		
	  }

	  else {
		  alert("oReq.status != 200");

	  }
  }

  oReq.send(oData);

  current_tag = oData;

  //https://developer.mozilla.org/en-US/docs/Web/API/FormData/entries
  //for(var pair of oData.entries()){
  //	  alert(pair[0]+': '+ pair[1]);
  //}
	  
  //When you use preventDefault(), you prevent the form from undergoing a traditional POST where your page would be submitted and reloaded. 
  ev.preventDefault();

}); 
</script>

{% endblock %}

